on:
 push:
   branches:
   - main
   paths:
   - 'new/forever/provider'

jobs:
  build:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: main pipeline
          run: |

            git clone https://github.com/maxxam123/platform03.git

            #path=/home/runner/work/platform03/platform03/cluster
            ls -la
            ls platform03
              
              NAME01=$( sed -n 1p new/_*/provider.tf )
              PROVIDER01=$( sed -n 2p new/_*/provider.tf )
              cp templates/pipelines/local_pipeline.yaml .

              sed -i -e "s/NAME01/$NAME01/g" local_pipeline.yaml      
              sed -i -e "s/PROVIDER01/$PROVIDER01/g" local_pipeline.yaml
              cp local_pipeline.yaml platform03/.github/workflows/$NAME01.yaml
              mkdir -p platform03/cluster/$NAME01
              cp new/_*/provider.tf platform03/cluster/$NAME01/
              cp new/_*/terraform.tfvars platform03/cluster/$NAME01/
      
              ### GITOPS ###
              REPLICAS=$( sed -n 3p new/_*/provider.tf )
              LOADBALANCER=$( sed -n 4p new/_*/provider.tf )
              SECRET=$( sed -n 5p new/_*/provider.tf )
              path=/home/runner/work/platform03/platform03/templates/gitops
            
              for each in $(ls $path); do
                cd $path/$each
              
                ### ESO
                echo inside gitops
                ls
                pwd
                mkdir -p ../../../gitops/NAME01
                mkdir -p ../../../gitops/NAME01/eso
                cp ../../../templates/gitops/NAME01/eso/* ../../../gitops/NAME01/eso/
                sed -i -e "s/NAME01/$SECRET/g" ../../../gitops/NAME01/eso/values.yaml
                
                ### NGINX
                mkdir -p ../../../gitops/NAME01
                mkdir -p ../../../gitops/NAME01/nginx
                cp ../../../templates/gitops/NAME01/nginx/* ../../../gitops/NAME01/nginx/
                sed -i -e "s/REPLICAS/$REPLICAS/g" ../../../gitops/NAME01/nginx/values.yaml
                sed -i -e "s/LOADBALANCER/$LOADBALANCER/g" ../../../gitops/NAME01/nginx/values.yaml
              done
              
              ls
              rm -rf platform03/new/_*
