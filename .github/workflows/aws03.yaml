on:
 push:
   branches:
   - main
   paths:
   #- 'cluster/aws03/provider.tf'
   - 'cluster/aws03/*'
jobs:
  build:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: bootstrapTerraform
          run: |

            git clone https://github.com/maxxam123/platform01.git

            NAME=$( sed -n 1p cluster/aws03/provider.tf )
            PROVIDER=$( sed -n 2p cluster/aws03/provider.tf )

            mkdir -p platform01/.github/workflows
            mkdir -p platform01/cluster/aws03
            mkdir -p platform01/gitops/aws03/{bootstrap,monitor}
            
            mkdir -p platform01/applications/aws03
            cp -r applications/aws03/create_application.yaml  platform01/applications/aws03/

            cp -r cluster/aws03/terraform.tfvars  platform01/cluster/aws03/
            cp -r cluster/aws03/provider.tfvars  platform01/cluster/aws03/
            cp -r cluster/aws03/application.tfvars  platform01/cluster/aws03/
            
            cp -r templates/pipelines/test_create.yaml platform01/.github/workflows/aws03.yaml
            cp -r gitops/aws03/bootstrap/* platform01/gitops/aws03/bootstrap/
            cp -r gitops/aws03/monitor/* platform01/gitops/aws03/monitor/

            sed -i -e "s/NAME/$NAME/g"         platform01/.github/workflows/aws03.yaml
            sed -i -e "s/PROVIDER/$PROVIDER/g" platform01/.github/workflows/aws03.yaml

            cat platform01/.github/workflows/aws03.yaml

            
        - name: Pushes to another repository
          uses: cpina/github-action-push-to-another-repository@main
          env:
            API_TOKEN_GITHUB: ${{ secrets.ACCESS_TOKEN }}
          with:
            source-directory: "platform01"
            destination-github-username: "maxxam123"
            destination-repository-name: "platform01"
            user-email: hennighausenmax@gmail.com
            target-branch: main
